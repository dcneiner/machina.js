/**
 * machina - A library for creating powerful and flexible finite state machines.  Loosely inspired by Erlang/OTP's gen_fsm behavior.
 * Author: Jim Cowart (http://freshbrewedcode.com/jimcowart)
 * Version: v0.4.0-rc1
 * Url: http://machina-js.org/
 * License(s): MIT, GPL
 */
(function(t,e){"object"==typeof module&&module.exports?module.exports=function(){return e(require("lodash"),require("monologue.js"),require("riveter"))}:"function"==typeof define&&define.amd?define(["lodash","monologue","riveter"],function(n,i,r){return e(n,i,r,t)}):t.machina=e(t._,t.Monologue,t.riveter,t)})(this,function(t,e,n,i,r){var a=[].slice,s="transition",o="handler",u="handling",c="handled",l="nohandler",p="transition",f="invalidstate",h="deferred",d="newfsm",g="registered",m={makeFsmNamespace:function(){var t=0;return function(){return"fsm."+t++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",states:{},namespace:m.makeFsmNamespace()}},getDefaultClientMeta:function(){return{currentAction:r,currentActionArgs:r,inExitHandler:!1,inputQueue:[],priorState:r,priorAction:r,state:r,targetReplayState:r,registered:!0}}},y=function(t,e){var n=t.getClientMeta(e),i=n.state;t.states[i]&&t.states[i]._onExit&&(t.inExitHandler=!0,t.states[i]._onExit.call(t,e,n),t.inExitHandler=!1)},v=function(t,e,n){var i=t.getClientMeta(e);i.targetReplayState=n,i.priorState=i.state,i.state=n,t.emit(p,{clientId:i.id,fromState:i.priorState,action:i.currentAction,toState:n})},A=function(t,e,n){var i=t.getClientMeta(e);t.states[n]._onEnter&&t.states[n]._onEnter.call(t,e,i),i.targetReplayState===n&&t.processQueue(e,s)},C=function(t,e,n,i){var r={state:i,clientId:e,inputType:n,type:l};t.emit(l,r)},M=function(t,e,n){var i,r=t.getClientMeta(n),a=t.states,s=r.state,o=a[s][e]?e:"*";return a[s][e]||a[s]["*"]||t["*"]?i={inputType:e,name:o,catchAll:"*"===o,handler:a[s][o]||t["*"],action:a[s][o]?o:"*"}:C(t,r.id,e,s),i},S=function(t,e,n,i){var a=(t.states,"string"==typeof i.handler?i.handler:r),s=t.getClientMeta(e);if(s.currentAction=i.action,t.emit(u,{clientId:s.id,inputType:i.inputType}),"function"==typeof i.handler){var o=t.getHandlerArgs(n);o=o.slice(i.catchAll?1:2).concat([e,s]),s.currentActionArgs=n,a=i.handler.apply(t,o),s.currentActionArgs=r}a&&t.transition(e,a)},x=function(t,e,n){var i=t.getClientMeta(e);t.emit(c,n),i.priorAction=i.currentAction,i.currentAction="",t.processQueue(e,o)},Q=function(e){e=e||{};var n=e.eventListeners||{};t.each(n,function(t,e){this.on(e,t).withContext(this)},this),delete e.eventListeners,t.merge(this,e),t.defaults(this,m.getDefaultOptions()),this.initialize.apply(this,arguments),H.emit(d,this)};t.extend(Q.prototype,{initialize:function(){},getClientMeta:function(t){return t.__machina?t.__machina:t.__machina={}},getClientId:function(t){return t.namespace},getHandlerArgs:function(t){return[t[0]].concat(a.call(t,2))},register:function(e){var n=this.getClientMeta(e);n=t.defaults(this.getClientMeta(e),m.getDefaultClientMeta(),{id:this.getClientId(e)}),this.emit(g,n),!n.state&&this.initialState&&this.transition(this.initialState,e)},transition:function(t,e){var n=this.getClientMeta(t);n.registered||this.register(t);n.state;n.inExitHandler||e===n.state||(this.states[e]?(y(this,t),v(this,t,e),A(this,t,e)):(info={clientId:n.id,state:n.state,attemptedState:e},this.emit(f,info)))},handle:function(t,e){var n,i=a.call(arguments,0),r=this.getClientMeta(t);r.registered||this.register(t),!r.inExitHandler&&(n=M(this,e,t))&&(S(this,t,i,n),x(this,t,{clientId:r.id,inputType:e}))},deferUntilTransition:function(t,e){var n=this.getClientMeta(t),i={type:s,untilState:e,args:n.currentActionArgs};n.inputQueue.push(i),this.emit(h,{clientId:n.id,state:n.state,inputType:n.currentAction})},deferUntilNextHandler:function(t){var e=this.getClientMeta(t);if(e.currentActionArgs){var n={type:o,args:e.currentActionArgs};e.inputQueue.push(n),this.emit(h,{clientId:e.id,state:e.state,inputType:e.currentAction})}},processQueue:function(e,n){var i=this.getClientMeta(e),r=n===s?function(t){return t.type===s&&(!t.untilState||t.untilState===i.state)}:function(t){return t.type===o},a=t.filter(i.inputQueue,r);i.inputQueue=t.difference(i.inputQueue,a),t.each(a,function(t){console.log("Processing Item: "+t.args[1]),this.handle.apply(this,t.args)},this)},clearQueue:function(e,n,i){var r=this.getClientMeta(e);if(n){var a;n===s?a=function(t){return t.type===s&&(i?t.untilState===i:!0)}:n===o&&(a=function(t){return t.type===o}),r.inputQueue=t.filter(r.inputQueue,a)}else r.inputQueue=[]}}),n(Q),Q.inherits(e);var _=Q.extend({constructor:function(){_.prototype.constructor.__super.apply(this,arguments),this.register()},getHandlerArgs:function(t){return a.call(t,2)},handle:function(){var t=a.call(arguments,0);return Q.prototype.handle.apply(this,t[0]===this?t:[this].concat(t))},transition:function(){var t=a.call(arguments,0);return Q.prototype.transition.apply(this,t[0]===this?t:[this].concat(t))},register:function(){return Q.prototype.register.call(this,this)},getClient:function(){return this},getClientMeta:function(){return this}},{},{deep:!0}),E=Q.extend({handle:function(t){var e=a.call(arguments,1),n=this;n.getClient(t,function(){Q.prototype.handle.apply(n,[n].concat(e))})},transition:function(t){var e=a.call(arguments,1),n=this;n.getClient(t,function(){Q.prototype.transition.apply(n,[n].concat(e))})},register:function(t){var e=this;e.getClient(t,function(){Q.prototype.register.call(e,e)})},deferUntilTransition:function(){throw new Error("Async/Remote FSMs do not support deferred input(s). Sorry.")},deferUntilNextHandler:function(){throw new Error("Async/Remote FSMs do not support deferred input(s). Sorry.")},processQueue:function(){},clearQueue:function(){}}),H=t.extend({Functional:Q,Fsm:_,Async:E,utils:m},e.prototype);return H});