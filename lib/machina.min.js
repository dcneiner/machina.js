/**
 * machina - A library for creating powerful and flexible finite state machines.  Loosely inspired by Erlang/OTP's gen_fsm behavior.
 * Author: Jim Cowart (http://ifandelse.com)
 * Version: v0.4.0
 * Url: http://machina-js.org/
 * License(s): MIT, GPL
 */
(function(t,e){"function"==typeof define&&define.amd?define(["lodash"],function(i){return e(i,t)}):"object"==typeof module&&module.exports?module.exports=e(require("lodash")):t.machina=e(t._,t)})(this,function(t,e,i){function n(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},namespace:g.makeFsmNamespace()}}function s(){return{inputQueue:[],targetReplayState:"",state:i,priorState:i,priorAction:"",currentAction:"",currentActionArgs:i,inExitHandler:!1}}function r(t,e){for(var i=[],n=0;n<t.length;n++)i[n]=t[n];return i.slice(e||0)}function a(e){t.extend(this,e),t.defaults(this,n()),this.initialize.apply(this,arguments),H.emit(m,this)}var u=[].slice,o="transition",c="handler",h="handling",l="handled",p="nohandler",f="transition",d="invalidstate",v="deferred",m="newfsm",g={makeFsmNamespace:function(){var t=0;return function(){return"fsm."+t++}}(),getDefaultOptions:function(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},eventQueue:[],namespace:g.makeFsmNamespace(),targetReplayState:"",state:i,priorState:i,_priorAction:"",_currentAction:""}}};if(!t.deepExtend){var y={"*":function(t,e,i){t[e]=i},object:function(t,e,i){t[e]=S({},t[e]||{},i)},array:function(e,i,n){e[i]=[],t.each(n,function(t,n){y[x(t)](e[i],n,t)},this)}},A=function(e){return t.isArray(e)?"array":t.isDate(e)?"date":t.isRegExp(e)?"regex":typeof e},x=function(t){var e=A(t);return y[e]?e:"*"},S=function(e){return t.each(u.call(arguments,1),function(i){t.each(i,function(t,i){y[x(t)](e,i,t)})}),e};t.mixin({deepExtend:S})}var Q=function(e){t.extend(this,e),t.defaults(this,g.getDefaultOptions()),this.initialize.apply(this,arguments),H.emit(m,this),this.initialState&&this.transition(this.initialState)};t.extend(Q.prototype,{initialize:function(){},emit:function(e){var i=arguments;this.eventListeners["*"]&&t.each(this.eventListeners["*"],function(t){try{t.apply(this,u.call(i,0))}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.toString())}},this),this.eventListeners[e]&&t.each(this.eventListeners[e],function(t){try{t.apply(this,u.call(i,1))}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.toString())}},this)},handle:function(e){if(!this.inExitHandler){var n,s,r,a,o=this.states,f=this.state,d=u.call(arguments,0);return this.currentActionArgs=d,o[f][e]||o[f]["*"]||this["*"]?(n=o[f][e]?e:"*",r="*"===n,o[f][n]?(s=o[f][n],a=f+"."+n):(s=this["*"],a="*"),this._currentAction||(this._currentAction=a),this.emit.call(this,h,{inputType:e,args:d.slice(1)}),t.isFunction(s)&&(s=s.apply(this,r?d:d.slice(1))),t.isString(s)&&this.transition(s),this.emit.call(this,l,{inputType:e,args:d.slice(1)}),this._priorAction=this._currentAction,this._currentAction="",this.processQueue(c)):this.emit.call(this,p,{inputType:e,args:d.slice(1)}),this.currentActionArgs=i,s}},transition:function(t){if(!this.inExitHandler&&t!==this.state){var e=this.state;if(this.states[t])return e&&this.states[e]&&this.states[e]._onExit&&(this.inExitHandler=!0,this.states[e]._onExit.call(this),this.inExitHandler=!1),this.targetReplayState=t,this.priorState=e,this.state=t,this.emit.call(this,f,{fromState:this.priorState,action:this._currentAction,toState:t}),this.states[t]._onEnter&&this.states[t]._onEnter.call(this),void(this.targetReplayState===t&&this.processQueue(o));this.emit.call(this,d,{state:this.state,attemptedState:t})}},processQueue:function(e){var i=e===o?function(t){return t.type===o&&(!t.untilState||t.untilState===this.state)}:function(t){return t.type===c},n=t.filter(this.eventQueue,i,this);this.eventQueue=t.difference(this.eventQueue,n),t.each(n,function(t){this.handle.apply(this,t.args)},this)},clearQueue:function(e,i){if(e){var n;e===o?n=function(t){return t.type===o&&(i?t.untilState===i:!0)}:e===c&&(n=function(t){return t.type===c}),this.eventQueue=t.filter(this.eventQueue,n)}else this.eventQueue=[]},deferUntilTransition:function(t){if(this.currentActionArgs){var e={type:o,untilState:t,args:this.currentActionArgs};this.eventQueue.push(e),this.emit.call(this,v,{state:this.state,queuedArgs:e})}},deferUntilNextHandler:function(){if(this.currentActionArgs){var t={type:c,args:this.currentActionArgs};this.eventQueue.push(t),this.emit.call(this,v,{state:this.state,queuedArgs:t})}},on:function(t,e){var i=this;return i.eventListeners[t]||(i.eventListeners[t]=[]),i.eventListeners[t].push(e),{eventName:t,callback:e,off:function(){i.off(t,e)}}},off:function(e,i){e?this.eventListeners[e]&&(this.eventListeners[e]=i?t.without(this.eventListeners[e],i):[]):this.eventListeners={}}}),Q.prototype.trigger=Q.prototype.emit;var L=["states","initialState"],_=function(e,i,n){var s,r={},a=function(){};return s=i&&i.hasOwnProperty("constructor")?i.constructor:function(){var i=u.call(arguments,0);i[0]=i[0]||{};var n,s=i[0].states||{};n=t.deepExtend(t.cloneDeep(r),{states:s}),n.initialState=i[0].initialState||this.initialState,t.extend(i[0],n),e.apply(this,i)},t.deepExtend(s,e),a.prototype=e.prototype,s.prototype=new a,i&&(t.extend(s.prototype,i),t.deepExtend(r,t.transform(i,function(t,e,i){-1!==L.indexOf(i)&&(t[i]=e)}))),n&&t.deepExtend(s,n),s.prototype.constructor=s,s.__super__=e.prototype,s};Q.extend=function(t,e){var i=_(this,t,e);return i.extend=this.extend,i};var E="__machina__";t.extend(a.prototype,{initialize:function(){},initClient:function(t){var e=this.initialState;e&&this.transition(t,e)},ensureClientMeta:function(e){if("object"!=typeof e)throw new Error("A BehavioralFsm client must be an object, not a primitive.");return e[E]||(e[E]=t.cloneDeep(s()),this.initClient(e)),e[E]},emit:function(e){var i=r(arguments);t.each(t.pick(this.eventListeners,"*",e),function(e){t.each(e,function(t){try{t.apply(this,i)}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.toString())}},this)},this)},on:function(t,e){var i=this;return i.eventListeners[t]||(i.eventListeners[t]=[]),i.eventListeners[t].push(e),{eventName:t,callback:e,off:function(){i.off(t,e)}}},off:function(e,i){e?this.eventListeners[e]&&(this.eventListeners[e]=i?t.without(this.eventListeners[e],i):[]):this.eventListeners={}},handle:function(t,e){var i=this.ensureClientMeta(t),n=r(arguments),s=i.state;i.currentActionArgs=n.slice(1);var a,u,o,f=!1;i.inExitHandler?this.emit(p,{inputType:e,client:t}):(a=this.states[s][e]?e:"*",f="*"===a,u=this.states[s][a]||this[a]||this["*"],action=i.state+"."+a,i.currentAction=action,this.emit(h,{client:t,inputType:e}),"function"==typeof u?o=u.apply(this,f?n:[n[0]].concat(n.slice(2))):(o=u,this.transition(t,u)),this.emit(l,{client:t,inputType:e}),i.priorAction=i.currentAction,i.currentAction="",this.processQueue(t,c))},transition:function(t,e){var i=this.ensureClientMeta(t),n=i.state;if(!i.inExitHandler&&e!==n){if(this.states[e])return n&&this.states[n]&&this.states[n]._onExit&&(i.inExitHandler=!0,this.states[n]._onExit.call(this,t),i.inExitHandler=!1),i.targetReplayState=e,i.priorState=n,i.state=e,this.emit.call(this,f,{fromState:i.priorState,action:i.currentAction,toState:e}),this.states[e]._onEnter&&this.states[e]._onEnter.call(this,t),void(i.targetReplayState===e&&this.processQueue(t,o));this.emit.call(this,d,{state:i.state,attemptedState:e})}},deferUntilTransition:function(t,e){var i=this.ensureClientMeta(t);if(i.currentActionArgs){var n={type:o,untilState:e,args:i.currentActionArgs};i.inputQueue.push(n),this.emit(v,{state:i.state,queuedArgs:n})}},deferUntilNextHandler:function(t){var e=this.ensureClientMeta(t);if(e.currentActionArgs){var i={type:c,args:e.currentActionArgs};e.inputQueue.push(i),this.emit(v,{state:e.state,queuedArgs:i})}},processQueue:function(e,i){var n=this.ensureClientMeta(e),s=i===o?function(t){return t.type===o&&(!t.untilState||t.untilState===n.state)}:function(t){return t.type===c},r=t.filter(n.inputQueue,s);n.inputQueue=t.difference(n.inputQueue,r),t.each(r,function(t){this.handle.apply(this,[e].concat(t.args))},this)},clearQueue:function(e,i,n){var s=this.ensureClientMeta(e);if(i){var r;i===o?r=function(t){return t.type===o&&(n?t.untilState===n:!0)}:i===c&&(r=function(t){return t.type===c}),s.inputQueue=t.filter(s.inputQueue,r)}else s.inputQueue=[]}}),a.extend=function(t,e){var i=_(this,t,e);return i.extend=this.extend,i};var C=a.extend({constructor:function(){a.apply(this,arguments),this.ensureClientMeta()},initClient:function(){var t=this.initialState;t&&this.transition(t)},ensureClientMeta:function(){return this._stamped||(this._stamped=!0,t.defaults(this,t.cloneDeep(s())),this.initClient()),this},handle:function(){return a.prototype.handle.apply(this,arguments[0]===this?arguments:[this].concat(r(arguments)))},transition:function(t){return a.prototype.transition.apply(this,arguments[0]===this?arguments:[this].concat(t))},deferUntilTransition:function(t){return a.prototype.deferUntilTransition.apply(this,arguments[0]===this?arguments:[this].concat(t))},deferUntilNextHandler:function(){return a.prototype.deferUntilNextHandler.apply(this,arguments[0]===this?arguments:[])},processQueue:function(t){return a.prototype.processQueue.apply(this,arguments[0]===this?arguments:[this].concat(t))},clearQueue:function(t,e){return a.prototype.clearQueue.apply(this,arguments[0]===this?arguments:[this].concat([t,e]))}}),H={Fsm:C,BehavioralFsm:a,NewFsm:C,utils:g,on:function(t,e){return this.eventListeners[t]||(this.eventListeners[t]=[]),this.eventListeners[t].push(e),e},off:function(e,i){this.eventListeners[e]&&(this.eventListeners[e]=t.without(this.eventListeners[e],i))},trigger:function(e){var i=arguments,n=this.eventListeners[e]||[];n&&n.length&&t.each(n,function(t){t.apply(null,u.call(i,1))})},eventListeners:{newFsm:[]}};return H.emit=H.trigger,H});
