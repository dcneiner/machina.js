/**
 * machina - A library for creating powerful and flexible finite state machines. Loosely inspired by Erlang/OTP's gen_fsm behavior.
 * Author: Jim Cowart (http://ifandelse.com)
 * Version: v0.5.0-1
 * Url: http://machina-js.org/
 * License(s): MIT, GPL
 */
(function(t,e){"function"==typeof define&&define.amd?define(["lodash"],function(n){return e(n,t)}):"object"==typeof module&&module.exports?module.exports=e(require("lodash")):t.machina=e(t._,t)})(this,function(t,e,n){function i(){return{initialState:"uninitialized",eventListeners:{"*":[]},states:{},namespace:y.makeFsmNamespace(),useSafeEmit:!1}}function s(){return{inputQueue:[],targetReplayState:"",state:n,priorState:n,priorAction:"",currentAction:"",currentActionArgs:n,inExitHandler:!1}}function r(t,e){for(var n=[],i=0;i<t.length;i++)n[i]=t[i];return n.slice(e||0)}function a(e){t.extend(this,e),t.defaults(this,i()),this.initialize.apply(this,arguments),x.emit(m,this)}var o=[].slice,u="transition",c="handling",l="handled",h="nohandler",p="transition",f="invalidstate",d="deferred",m="newfsm",v=["states","initialState"],g=function(e,n){var i,s=this,r={},a=function(){};return i=e&&e.hasOwnProperty("constructor")?e.constructor:function(){var e=o.call(arguments,0);e[0]=e[0]||{};var n,i=e[0].states||{};n=t.merge(t.cloneDeep(r),{states:i}),n.initialState=e[0].initialState||this.initialState,t.extend(e[0],n),s.apply(this,e)},t.merge(i,s),a.prototype=s.prototype,i.prototype=new a,e&&(t.extend(i.prototype,e),t.merge(r,t.transform(e,function(t,e,n){-1!==v.indexOf(n)&&(t[n]=e)}))),n&&t.merge(i,n),i.prototype.constructor=i,i.__super__=s.prototype,i},y={makeFsmNamespace:function(){var t=0;return function(){return"fsm."+t++}}(),getDefaultOptions:i,getDefaultClientMeta:s},S={emit:function(e){var n=r(arguments);this.eventListeners["*"]&&t.each(this.eventListeners["*"],function(t){if(this.useSafeEmit)try{t.apply(this,n)}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.stack)}else t.apply(this,n)},this),this.eventListeners[e]&&t.each(this.eventListeners[e],function(t){if(this.useSafeEmit)try{t.apply(this,n.slice(1))}catch(e){console&&"undefined"!=typeof console.log&&console.log(e.stack)}else t.apply(this,n.slice(1))},this)},on:function(t,e){var n=this;return n.eventListeners=n.eventListeners||{"*":[]},n.eventListeners[t]||(n.eventListeners[t]=[]),n.eventListeners[t].push(e),{eventName:t,callback:e,off:function(){n.off(t,e)}}},off:function(e,n){this.eventListeners=this.eventListeners||{"*":[]},e?this.eventListeners[e]=n?t.without(this.eventListeners[e],n):[]:this.eventListeners={}}},E="__machina__";t.extend(a.prototype,{initialize:function(){},initClient:function(t){var e=this.initialState;if(!e)throw new Error("You must specify an initial state for this FSM");if(!this.states[e])throw new Error("The initial state specified does not exist in the states object.");this.transition(t,e)},ensureClientMeta:function(e){if("object"!=typeof e)throw new Error("A BehavioralFsm client must be an object, not a primitive.");return e[E]||(e[E]=t.cloneDeep(s()),this.initClient(e)),e[E]},buildEventPayload:function(e,n){return t.isPlainObject(n)?t.extend(n,{client:e}):{client:e,data:n||null}},getHandlerArgs:function(t,e){return e?t:[t[0]].concat(t.slice(2))},handle:function(t,e){var n=this.ensureClientMeta(t),i=r(arguments),s=n.state;n.currentActionArgs=i.slice(1);var a,o,u,p=!1;if(!n.inExitHandler){a=this.states[s][e]?e:"*",p="*"===a,o=this.states[s][a]||this[a]||this["*"],action=n.state+"."+a,n.currentAction=action;var f=this.buildEventPayload(t,{inputType:e});o?(this.emit(c,f),"function"==typeof o?u=o.apply(this,this.getHandlerArgs(i,p)):(u=o,this.transition(t,o)),this.emit(l,f)):this.emit(h,f),n.priorAction=n.currentAction,n.currentAction=""}return u},transition:function(t,e){var n=this.ensureClientMeta(t),i=n.state;if(!n.inExitHandler&&e!==i){if(this.states[e]){i&&this.states[i]&&this.states[i]._onExit&&(n.inExitHandler=!0,this.states[i]._onExit.call(this,t),n.inExitHandler=!1),n.targetReplayState=e,n.priorState=i,n.state=e;var s=this.buildEventPayload(t,{fromState:n.priorState,action:n.currentAction,toState:e});return this.emit(p,s),this.states[e]._onEnter&&this.states[e]._onEnter.call(this,t),void(n.targetReplayState===e&&this.processQueue(t,u))}this.emit.call(this,f,{state:n.state,attemptedState:e})}},deferUntilTransition:function(t,e){var n=this.ensureClientMeta(t);if(n.currentActionArgs){var i={type:u,untilState:e,args:n.currentActionArgs};n.inputQueue.push(i);var s=this.buildEventPayload(t,{state:n.state,queuedArgs:i});this.emit(d,s)}},processQueue:function(e){var n=this.ensureClientMeta(e),i=function(t){return!t.untilState||t.untilState===n.state},s=t.filter(n.inputQueue,i);n.inputQueue=t.difference(n.inputQueue,s),t.each(s,function(t){this.handle.apply(this,[e].concat(t.args))},this)},clearQueue:function(e,n){var i=this.ensureClientMeta(e);if(n){var s=function(t){return n?t.untilState!==n:!0};i.inputQueue=t.filter(i.inputQueue,s)}else i.inputQueue=[]}},S),a.extend=g;var A=a.extend({constructor:function(){a.apply(this,arguments),this.ensureClientMeta()},initClient:function(){var t=this.initialState;if(!t)throw new Error("You must specify an initial state for this FSM");if(!this.states[t])throw new Error("The initial state specified does not exist in the states object.");this.transition(t)},ensureClientMeta:function(){return this._stamped||(this._stamped=!0,t.defaults(this,t.cloneDeep(s())),this.initClient()),this},getHandlerArgs:function(t,e){return t.slice(e?1:2)},buildEventPayload:function(){var t=(arguments[0]===this?arguments[1]:arguments[0])||null;return t},handle:function(){return a.prototype.handle.apply(this,arguments[0]===this?arguments:[this].concat(r(arguments)))},transition:function(t){return a.prototype.transition.apply(this,arguments[0]===this?arguments:[this].concat(t))},deferUntilTransition:function(t){return a.prototype.deferUntilTransition.apply(this,arguments[0]===this?arguments:[this].concat(t))},processQueue:function(){return a.prototype.processQueue.apply(this,arguments[0]===this?arguments:[this])},clearQueue:function(t){return a.prototype.clearQueue.apply(this,arguments[0]===this?arguments:[this].concat([t]))}}),x=t.merge(S,{Fsm:A,BehavioralFsm:a,utils:y,eventListeners:{newFsm:[]}});return x});